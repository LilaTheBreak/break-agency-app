# V1.1 Contract E-Signature - Phase 3 Implementation

**Date:** January 2025  
**Status:** ✅ Complete - Ready for Testing

---

## Overview

Phase 3 implements full DocuSign integration for contract e-signatures:
- OAuth connection with secure token storage
- Contract sending for signature via DocuSign
- Webhook handling for signature status updates
- Automatic contract status updates
- Signed PDF storage with versioning

---

## 1. Schema Changes ✅

### Contract Model
- ✅ Added `signedPdfUrl` field - Stores signed PDF URL from e-signature provider
- ✅ Added `envelopeId` field - Stores DocuSign envelope ID (or other provider ID)
- ✅ Added `envelopeId` index for efficient lookups

**Migration Required:**
```bash
npx prisma db push
```

---

## 2. Provider Integration ✅

### DocuSign OAuth Implementation
**File:** `apps/api/src/services/signature/docusignAuth.ts`

**Functions:**
- ✅ `getDocuSignAuthUrl(userId)` - Generates OAuth authorization URL
- ✅ `exchangeDocuSignCode(code)` - Exchanges code for tokens and account ID
- ✅ `getDocuSignToken()` - Gets/refreshes access token (auto-refresh within 5 minutes of expiration)
- ✅ `storeDocuSignConnection()` - Stores connection (reuses XeroConnection model structure)

**OAuth Flow:**
1. User initiates connection → Redirects to DocuSign OAuth
2. User authorizes → DocuSign redirects to callback with code
3. Exchange code for tokens → Get access token, refresh token, account ID, base URL
4. Store connection → Save to database

**Token Management:**
- Access tokens expire in 8 hours (DocuSign default)
- Auto-refresh when within 5 minutes of expiration
- Refresh tokens stored securely
- Connection marked as disconnected if refresh fails

**Scopes:**
- `signature` - Create and manage envelopes
- `impersonation` - Act on behalf of users

---

## 3. DocuSign API Client ✅

**File:** `apps/api/src/services/signature/providers/docusignProvider.ts`

**Implementation:**
- ✅ Real DocuSign API integration (replaces stub)
- ✅ `sendSignatureRequest()` - Creates envelope and sends for signature
- ✅ `getSignedPdf()` - Downloads signed PDF from DocuSign
- ✅ `parseWebhook()` - Parses DocuSign webhook payloads

**Envelope Creation:**
- Downloads PDF from URL and converts to base64
- Creates DocuSign envelope with:
  - Email subject
  - Document (PDF)
  - Signer information (email, name)
  - Signature tab placement (bottom of first page)
- Sends envelope with status "sent"

**Signature Tab Placement:**
- Default position: x=100, y=700 on page 1
- Can be customized via contract metadata

---

## 4. Contract Lifecycle ✅

### Send Contract for Signature
**File:** `apps/api/src/services/signature/orchestrator.ts`

**When Triggered:**
- `POST /api/contracts/:id/sign/talent` - Send to talent
- `POST /api/contracts/:id/sign/brand` - Send to brand

**Process:**
1. Validate contract has PDF URL
2. Get signer email and name from contract/deal/brand
3. Create SignatureRequest record
4. Call provider to send signature request
5. Store envelope ID in SignatureRequest and Contract
6. Update contract status to "pending_signature"

### Track Signing Status
**File:** `apps/api/src/routes/signatureWebhooks.ts`

**Webhook Handler:**
- Receives DocuSign webhook events
- Parses envelope ID and status
- Updates SignatureRequest status
- Handles "signed" status:
  - Downloads signed PDF from DocuSign
  - Stores in GCS with versioning
  - Updates contract with signed PDF URL
  - Updates contract status based on signer

**Status Updates:**
- `pending` → `sent` → `signed` → `fully_signed`
- Tracks talent and brand signatures separately
- Updates `talentSignedAt` and `brandSignedAt` timestamps
- Sets `fullySignedAt` when both parties sign

### Automatic Contract Status Updates
**File:** `apps/api/src/routes/signatureWebhooks.ts`

**Status Flow:**
1. First signature → `partially_signed`
2. Second signature → `fully_signed`
3. Updates deal `contractSignedAt` when fully signed

**Signer Detection:**
- Compares signer email with talent/brand emails
- Updates appropriate timestamp field
- Handles both single and dual-signature contracts

---

## 5. File Handling ✅

### Store Signed PDFs in GCS
**File:** `apps/api/src/routes/signatureWebhooks.ts`

**Process:**
1. Download signed PDF from DocuSign
2. Upload to GCS in `contracts/signed/` folder
3. Filename format: `contract-{contractId}-signed-{timestamp}.pdf`
4. Store signed URL in contract `signedPdfUrl` field
5. Also store in SignatureRequest `signedPdfUrl` field

**Versioning:**
- Original PDF: `contracts/{contractId}.pdf` (from `pdfUrl`)
- Signed PDF: `contracts/signed/contract-{contractId}-signed-{timestamp}.pdf`
- Both files preserved for audit trail

**Storage Service:**
- Uses `uploadFileToGCS()` from `googleCloudStorage.ts`
- Files organized by user ID and folder
- Signed URLs generated for access

---

## 6. Webhook Handlers ✅

**File:** `apps/api/src/routes/signatureWebhooks.ts`

**Endpoint:** `POST /api/webhooks/signature`

**Features:**
- ✅ Gated behind `CONTRACT_SIGNING_ENABLED` feature flag
- ✅ Parses DocuSign webhook payload
- ✅ Finds SignatureRequest by envelope ID
- ✅ Updates signature status
- ✅ Downloads and stores signed PDF
- ✅ Updates contract status automatically
- ✅ Handles errors gracefully (always returns 200 to DocuSign)

**Webhook Configuration:**
- DocuSign webhook URL: `https://yourdomain.com/api/webhooks/signature`
- Events to subscribe: `envelope-sent`, `envelope-delivered`, `envelope-signed`, `envelope-completed`
- Authentication: Configure in DocuSign Connect settings

---

## 7. Contract Routes ✅

**File:** `apps/api/src/routes/contracts.ts`

### Updated Routes

**POST /api/contracts/:id/sign/talent**
- ✅ Gated behind `CONTRACT_SIGNING_ENABLED`
- ✅ Gets talent email from Deal.Talent
- ✅ Sends signature request via orchestrator
- ✅ Returns envelope ID and request ID

**POST /api/contracts/:id/sign/brand**
- ✅ Gated behind `CONTRACT_SIGNING_ENABLED`
- ✅ Gets brand email from Brand model
- ✅ Sends signature request via orchestrator
- ✅ Returns envelope ID and request ID

**Error Handling:**
- Returns 503 if feature disabled
- Returns 404 if contract not found
- Returns 400 if PDF missing or email not found
- Returns 500 with error message on failure

---

## 8. Feature Flag ✅

**File:** `apps/web/src/config/features.js`

- ✅ `CONTRACT_SIGNING_ENABLED: true` (default)
- ✅ All routes check feature flag
- ✅ Returns 503 when disabled

**Environment Variable:**
```bash
CONTRACT_SIGNING_ENABLED=true
SIGN_PROVIDER=docusign
```

---

## 9. Contract Signing Flow Diagram

```
1. Admin Creates Contract
   └─> Contract created with pdfUrl
       └─> Status: "draft"

2. Admin Sends for Signature
   └─> POST /api/contracts/:id/sign/talent
       ├─> Create SignatureRequest record
       ├─> Call DocuSign API to create envelope
       ├─> Store envelopeId in Contract and SignatureRequest
       └─> Status: "pending_signature"

3. Signer Receives Email
   └─> DocuSign sends email with signing link
       └─> Signer clicks link → DocuSign hosted signing page

4. Signer Signs Document
   └─> DocuSign processes signature
       └─> DocuSign sends webhook to /api/webhooks/signature

5. Webhook Handler Processes Signature
   └─> Download signed PDF from DocuSign
       ├─> Upload to GCS (contracts/signed/)
       ├─> Update Contract.signedPdfUrl
       ├─> Update Contract status (partially_signed or fully_signed)
       ├─> Update talentSignedAt or brandSignedAt
       └─> Update Deal.contractSignedAt if fully signed

6. Contract Fully Signed
   └─> Status: "fully_signed"
       └─> Both original and signed PDFs available
```

---

## 10. Testing Checklist

### OAuth Flow
- [ ] Connect button generates correct OAuth URL
- [ ] OAuth callback exchanges code successfully
- [ ] Connection stored in database
- [ ] Token refresh works automatically
- [ ] Connection status endpoint returns correct info

### Signature Request
- [ ] Contract sent for signature creates envelope
- [ ] Envelope ID stored in contract
- [ ] Signature request email sent to signer
- [ ] Signer can access DocuSign signing page
- [ ] Error handling works if send fails

### Webhook Processing
- [ ] Webhook receives DocuSign events
- [ ] Envelope ID matched to SignatureRequest
- [ ] Signed PDF downloaded from DocuSign
- [ ] Signed PDF uploaded to GCS
- [ ] Contract status updated correctly
- [ ] Timestamps set correctly
- [ ] Deal updated when fully signed

### File Versioning
- [ ] Original PDF preserved
- [ ] Signed PDF stored separately
- [ ] Both PDFs accessible via URLs
- [ ] Filenames include timestamps

### Error Handling
- [ ] Expired tokens refresh automatically
- [ ] Webhook errors don't crash handler
- [ ] Missing signer email handled gracefully
- [ ] PDF download failures logged

---

## 11. Environment Variables Required

```bash
# Feature flag
CONTRACT_SIGNING_ENABLED=true

# Provider selection
SIGN_PROVIDER=docusign

# DocuSign OAuth credentials (from DocuSign Developer Portal)
DOCUSIGN_CLIENT_ID=...
DOCUSIGN_CLIENT_SECRET=...
DOCUSIGN_REDIRECT_URI=https://yourdomain.com/api/signature/docusign/callback
DOCUSIGN_ACCOUNT_ID=...  # Your DocuSign account ID
DOCUSIGN_BASE_URL=https://account.docusign.com  # or https://account-d.docusign.com for demo
DOCUSIGN_API_BASE_URL=https://demo.docusign.net/restapi  # or https://na1.docusign.net/restapi for production
```

**DocuSign Developer Portal Setup:**
1. Create app at https://developers.docusign.com
2. Set redirect URI
3. Get Client ID and Secret
4. Request scopes: `signature`, `impersonation`
5. Configure webhook in DocuSign Connect settings

---

## 12. Known Limitations

### Phase 3 Scope
- ⚠️ **Single Signer Per Envelope** - Currently sends one envelope per signer (separate for talent and brand)
- ⚠️ **Signature Tab Position** - Hardcoded to bottom of first page (can be customized via metadata)
- ⚠️ **No Custom Fields** - Doesn't support DocuSign custom fields or data fields
- ⚠️ **No Reminders** - Doesn't send automatic reminders (can be configured in DocuSign)

### Future Enhancements
- Dual-signature envelopes (both parties in one envelope)
- Custom signature tab positions
- DocuSign custom fields
- Automatic reminder configuration
- Signature analytics and tracking
- Bulk signature requests

---

## 13. Files Created/Modified

### Created
- `apps/api/src/services/signature/docusignAuth.ts` - OAuth flow
- Updated `apps/api/src/services/signature/providers/docusignProvider.ts` - Real DocuSign API client

### Modified
- `apps/api/prisma/schema.prisma` - Added signedPdfUrl, envelopeId to Contract
- `apps/api/src/routes/signatureWebhooks.ts` - Real webhook handler
- `apps/api/src/routes/contracts.ts` - Feature flag gating
- `apps/api/src/services/signature/orchestrator.ts` - Store envelopeId in contract

---

## 14. UI Integration Notes

### Contract Detail Page
- Show "Send for Signature" button (gated behind feature flag)
- Display envelope ID if sent
- Show signature status (pending, partially_signed, fully_signed)
- Display signed PDF download link when available
- Show signature timestamps

### Admin Dashboard
- Show contracts awaiting signature
- Display signature completion rate
- Link to signed PDFs

**Note:** UI updates are not included in Phase 3 - backend is ready for UI integration.

---

## Conclusion

Phase 3 is complete and ready for testing. All core functionality is implemented:
- ✅ DocuSign OAuth connection
- ✅ Contract sending for signature
- ✅ Webhook handling
- ✅ Automatic status updates
- ✅ Signed PDF storage with versioning
- ✅ Feature flag gating

The system is ready for DocuSign credential configuration and testing.

