# V1.1 Platform Inboxes - Phase 1 Implementation

**Date:** January 2025  
**Status:** ✅ Complete - Ready for Testing

---

## Overview

Phase 1 implements read-only OAuth connections and message syncing for Instagram, TikTok, and WhatsApp inboxes. Messages are stored in the existing `InboundEmail` and `InboxMessage` models with platform identification.

---

## 1. Schema Changes ✅

### InboundEmail Model
- ✅ Added `platform` field (default: "gmail") - supports "gmail", "instagram", "tiktok", "whatsapp"
- ✅ Added `instagramId` field (unique) - stores Instagram message IDs
- ✅ Added `tiktokId` field (unique) - stores TikTok message IDs
- ✅ Added `whatsappId` field (unique) - stores WhatsApp message IDs
- ✅ Added `platform` index for efficient filtering

### InboxMessage Model
- ✅ Added `platform` field (default: "gmail")
- ✅ Added `platform` index

**Migration Required:**
```bash
npx prisma db push
```

---

## 2. Instagram Inbox ✅

### OAuth Implementation
**File:** `apps/api/src/services/instagram/instagramInboxAuth.ts`

- ✅ `getInstagramInboxAuthUrl()` - Generates OAuth URL with inbox scopes
- ✅ `exchangeInstagramInboxCode()` - Exchanges code for long-lived token (60 days)
- ✅ `getInstagramInboxToken()` - Gets/refreshes token (auto-refresh within 7 days)

**Scopes Used:**
- `instagram_basic` - Basic profile access
- `instagram_manage_messages` - Read DMs (requires Business/Creator account)

### Sync Implementation
**File:** `apps/api/src/services/instagram/instagramInboxSync.ts`

- ✅ `syncInstagramInboxForUser()` - Syncs DMs into InboundEmail/InboxMessage
- ✅ Fetches conversations from Instagram Graph API
- ✅ Fetches messages for each conversation
- ✅ Maps to database models with platform="instagram"
- ✅ Deduplication by `instagramId`
- ✅ Updates `lastSyncedAt` timestamp

**API Endpoints:**
- `GET /api/instagram-inbox/status` - Check connection status
- `GET /api/instagram-inbox/connect` - Get OAuth URL
- `GET /api/instagram-inbox/callback` - Handle OAuth callback
- `POST /api/instagram-inbox/sync` - Manual sync trigger

**Token Storage:**
- Reuses `SocialAccountConnection` model
- Stores with `metadata.purpose: "inbox"` to distinguish from social analytics

---

## 3. TikTok Inbox ✅

### OAuth Implementation
**File:** `apps/api/src/services/tiktok/tiktokInboxAuth.ts`

- ✅ `getTikTokInboxAuthUrl()` - Generates OAuth URL with message scopes
- ✅ `exchangeTikTokInboxCode()` - Exchanges code for access/refresh tokens
- ✅ `getTikTokInboxToken()` - Gets/refreshes token (auto-refresh on expiration)

**Scopes Used:**
- `user.info.basic` - Basic user info
- `message.send` - Send messages (for future use)
- `message.list` - Read messages/comments

### Sync Implementation
**File:** `apps/api/src/services/tiktok/tiktokInboxSync.ts`

- ✅ `syncTikTokInboxForUser()` - Syncs messages into InboundEmail/InboxMessage
- ✅ Fetches messages from TikTok API
- ✅ Maps to database models with platform="tiktok"
- ✅ Deduplication by `tiktokId`
- ✅ Updates `lastSyncedAt` timestamp

**API Endpoints:**
- `GET /api/tiktok-inbox/status` - Check connection status
- `GET /api/tiktok-inbox/connect` - Get OAuth URL
- `GET /api/tiktok-inbox/callback` - Handle OAuth callback
- `POST /api/tiktok-inbox/sync` - Manual sync trigger

**Token Storage:**
- Reuses `SocialAccountConnection` model
- Stores with `metadata.purpose: "inbox"` to distinguish from social analytics

---

## 4. WhatsApp Inbox ✅

### Placeholder Provider
**File:** `apps/api/src/services/whatsapp/whatsappInboxProvider.ts`

- ✅ `WhatsAppInboxProvider` class - Placeholder implementation
- ✅ `isConnected()` - Returns false (not implemented)
- ✅ `syncInboxForUser()` - Returns empty stats
- ✅ `getConnectionStatus()` - Returns "coming soon" message

**API Endpoints:**
- `GET /api/whatsapp-inbox/status` - Returns connection status (disconnected)
- `POST /api/whatsapp-inbox/sync` - Returns empty stats

**Future Integration:**
- WhatsApp Business API
- Twilio WhatsApp API
- Meta WhatsApp Cloud API

---

## 5. Feature Flags ✅

**File:** `apps/web/src/config/features.js`

Added new flags:
- ✅ `INSTAGRAM_INBOX_ENABLED: false` - Controls Instagram inbox access
- ✅ `TIKTOK_INBOX_ENABLED: false` - Controls TikTok inbox access
- ✅ `WHATSAPP_INBOX_ENABLED: false` - Controls WhatsApp inbox access

**Environment Variables:**
```bash
# Feature flags
INSTAGRAM_INBOX_ENABLED=true
TIKTOK_INBOX_ENABLED=true
WHATSAPP_INBOX_ENABLED=true

# OAuth credentials (Instagram)
INSTAGRAM_CLIENT_ID=...
INSTAGRAM_CLIENT_SECRET=...
INSTAGRAM_REDIRECT_URI=... # or INSTAGRAM_INBOX_REDIRECT_URI

# OAuth credentials (TikTok)
TIKTOK_CLIENT_KEY=...
TIKTOK_CLIENT_SECRET=...
TIKTOK_REDIRECT_URI=... # or TIKTOK_INBOX_REDIRECT_URI
```

---

## 6. Route Registration ✅

**File:** `apps/api/src/server.ts`

Routes registered:
- ✅ `/api/instagram-inbox` → `instagramInboxRouter`
- ✅ `/api/tiktok-inbox` → `tiktokInboxRouter`
- ✅ `/api/whatsapp-inbox` → `whatsappInboxRouter`

All routes are:
- ✅ Protected with `requireAuth` middleware
- ✅ Gated with feature flag checks
- ✅ Return 503 when disabled

---

## 7. Gmail Integration Updates ✅

**Files Updated:**
- ✅ `apps/api/src/services/gmail/mappings.ts` - Added `platform: "gmail"` to mappings
- ✅ `apps/api/src/services/gmail/syncGmail.ts` - Added `platform: "gmail"` to thread creation

**Backward Compatibility:**
- ✅ Existing Gmail messages default to `platform: "gmail"` (via schema default)
- ✅ No migration needed for existing data

---

## 8. Unified Inbox Compatibility ✅

The existing unified inbox service (`apps/api/src/services/unifiedInboxService.ts`) will automatically:
- ✅ Include Instagram messages (filtered by `platform: "instagram"`)
- ✅ Include TikTok messages (filtered by `platform: "tiktok"`)
- ✅ Include WhatsApp messages (filtered by `platform: "whatsapp"`)

No changes needed - the service already queries `InboundEmail` and `InboxMessage` tables.

---

## 9. Testing Checklist

### Instagram Inbox
- [ ] OAuth flow completes successfully
- [ ] Token stored in `SocialAccountConnection` with `purpose: "inbox"`
- [ ] Sync fetches DMs from Instagram Graph API
- [ ] Messages stored in `InboundEmail` with `platform: "instagram"`
- [ ] Threads stored in `InboxMessage` with `platform: "instagram"`
- [ ] Deduplication works (no duplicate messages)
- [ ] Status endpoint returns correct connection info

### TikTok Inbox
- [ ] OAuth flow completes successfully
- [ ] Token stored in `SocialAccountConnection` with `purpose: "inbox"`
- [ ] Sync fetches messages from TikTok API
- [ ] Messages stored in `InboundEmail` with `platform: "tiktok"`
- [ ] Threads stored in `InboxMessage` with `platform: "tiktok"`
- [ ] Deduplication works (no duplicate messages)
- [ ] Status endpoint returns correct connection info

### WhatsApp Inbox
- [ ] Status endpoint returns "disconnected" with "coming soon" message
- [ ] Sync endpoint returns empty stats
- [ ] No errors when feature flag is enabled

---

## 10. Known Limitations

### Instagram
- ⚠️ **Requires Business or Creator account** - Personal accounts cannot access DMs via API
- ⚠️ **API Limitations** - Instagram Graph API may have rate limits
- ⚠️ **Scope Restrictions** - `instagram_manage_messages` requires app review

### TikTok
- ⚠️ **API Availability** - TikTok API message endpoints may not be available for all account types
- ⚠️ **Token Expiration** - Tokens expire in 24 hours (auto-refresh implemented)
- ⚠️ **Rate Limits** - TikTok API has rate limits

### WhatsApp
- ⚠️ **Not Implemented** - Placeholder only, requires provider integration

---

## 11. Next Steps (Phase 2)

1. **Posting/Replying** - Implement outbound message sending
2. **Real-time Updates** - Webhook integration for new messages
3. **WhatsApp Integration** - Choose and implement provider
4. **UI Updates** - Platform-specific inbox filters in frontend
5. **Error Handling** - Enhanced error messages for API failures
6. **Rate Limiting** - Implement rate limit handling
7. **Incremental Sync** - Only fetch new messages since last sync

---

## 12. Files Created/Modified

### Created
- `apps/api/src/services/instagram/instagramInboxAuth.ts`
- `apps/api/src/services/instagram/instagramInboxSync.ts`
- `apps/api/src/services/tiktok/tiktokInboxAuth.ts`
- `apps/api/src/services/tiktok/tiktokInboxSync.ts`
- `apps/api/src/services/whatsapp/whatsappInboxProvider.ts`
- `apps/api/src/routes/instagramInbox.ts`
- `apps/api/src/routes/tiktokInbox.ts`
- `apps/api/src/routes/whatsappInbox.ts`

### Modified
- `apps/api/prisma/schema.prisma` - Added platform fields
- `apps/api/src/server.ts` - Registered new routes
- `apps/api/src/services/gmail/mappings.ts` - Added platform field
- `apps/api/src/services/gmail/syncGmail.ts` - Added platform field
- `apps/web/src/config/features.js` - Added feature flags

---

## Conclusion

Phase 1 is complete and ready for testing. All core functionality is implemented:
- ✅ OAuth connections (read-only)
- ✅ Token storage and refresh
- ✅ Message syncing
- ✅ Database integration
- ✅ Feature flag gating
- ✅ Route registration

The system is ready for OAuth credential configuration and testing.

