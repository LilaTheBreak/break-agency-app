# V1.1 Xero Integration - Phase 2 Implementation

**Date:** January 2025  
**Status:** ✅ Complete - Ready for Testing

---

## Overview

Phase 2 implements full Xero integration for invoice management:
- OAuth connection with secure token storage
- Invoice push to Xero when status changes from draft
- Payment status sync from Xero
- Error handling and sync status tracking

---

## 1. Schema Changes ✅

### Invoice Model
- ✅ Added `xeroId` field (unique) - Stores Xero invoice ID
- ✅ Added `xeroSyncError` field - Stores last sync error message
- ✅ Added `lastSyncedAt` field - Tracks last successful sync
- ✅ Added `xeroId` index for efficient lookups

**Migration Required:**
```bash
npx prisma db push
```

---

## 2. OAuth & Credentials ✅

### Xero OAuth Implementation
**File:** `apps/api/src/services/xero/xeroAuth.ts`

**Functions:**
- ✅ `getXeroAuthUrl()` - Generates OAuth authorization URL
- ✅ `exchangeXeroCode()` - Exchanges code for tokens and tenant ID
- ✅ `getXeroToken()` - Gets/refreshes access token (auto-refresh within 5 minutes of expiration)
- ✅ `storeXeroConnection()` - Stores connection in `XeroConnection` model

**OAuth Flow:**
1. User clicks "Connect Xero" → Redirects to Xero OAuth
2. User authorizes → Xero redirects to callback with code
3. Exchange code for tokens → Get access token, refresh token, tenant ID
4. Store connection → Save to `XeroConnection` model

**Token Management:**
- Access tokens expire in 30 minutes (Xero default)
- Auto-refresh when within 5 minutes of expiration
- Refresh tokens stored securely
- Connection marked as disconnected if refresh fails

**Scopes:**
- `accounting.transactions` - Create/read invoices
- `accounting.contacts` - Create/read contacts
- `offline_access` - Refresh token access

---

## 3. Invoice Sync ✅

### Push to Xero
**File:** `apps/api/src/services/xero/xeroInvoiceSync.ts`

**Function:** `pushInvoiceToXero(invoiceId: string)`

**When Triggered:**
- Invoice status changes from "draft" to "sent", "due", or "overdue"
- Handled in `PATCH /api/admin/finance/invoices/:id` route

**Process:**
1. Find invoice with deal and brand information
2. Skip if already synced (has `xeroId`)
3. Find or create contact in Xero
4. Create invoice in Xero with:
   - Contact information
   - Invoice number
   - Amount and currency
   - Issue date and due date
   - Line item description
5. Update invoice with `xeroId`
6. Store sync error if push fails

**Error Handling:**
- Errors stored in `invoice.xeroSyncError`
- Invoice update succeeds even if Xero push fails
- Errors logged for debugging

### Pull Payment Status
**File:** `apps/api/src/services/xero/xeroService.ts`

**Function:** `syncXeroPaymentStatuses()`

**Process:**
1. Find all invoices with `xeroId` that are not paid
2. For each invoice:
   - Fetch status from Xero API
   - Check for payments
   - Update invoice status to "paid" if Xero status is "PAID"
   - Update `paidAt` timestamp
   - Update `lastSyncedAt`
3. Update connection `lastSyncedAt`
4. Return sync statistics

**Manual Sync:**
- `POST /api/admin/finance/xero/sync` - Triggers full sync

**Automatic Sync:**
- Can be scheduled via cron job (not implemented in Phase 2)

---

## 4. XeroService API Client ✅

**File:** `apps/api/src/services/xero/xeroService.ts`

**Functions:**
- ✅ `createXeroInvoice()` - Creates invoice in Xero
- ✅ `getXeroInvoiceStatus()` - Gets invoice status and payment info
- ✅ `syncXeroPaymentStatuses()` - Syncs all invoices

**Contact Management:**
- Automatically finds existing contacts by name
- Creates new contact if not found
- Uses contact email if available

**Invoice Creation:**
- Maps to Xero invoice structure
- Uses account code "200" for Sales (default)
- Sets status to "AUTHORISED" (ready to send)
- Supports custom invoice numbers

**Payment Detection:**
- Fetches payments for each invoice
- Determines most recent payment date
- Calculates total paid amount

---

## 5. Admin Finance Routes ✅

**File:** `apps/api/src/routes/admin/finance.ts`

### Updated Routes

**PATCH /api/admin/finance/invoices/:id**
- ✅ Auto-pushes to Xero when status changes from "draft"
- ✅ Updates invoice with `xeroId` after successful push
- ✅ Stores sync errors if push fails

**GET /api/admin/finance/invoices/:id**
- ✅ Returns `xeroId`, `xeroSyncError`, `lastSyncedAt` fields

### New Routes

**GET /api/admin/finance/xero/status**
- Returns connection status
- Shows tenant ID, expiration, last sync time
- Displays sync statistics

**GET /api/admin/finance/xero/connect**
- Returns OAuth authorization URL
- Gated behind `XERO_INTEGRATION_ENABLED` flag

**GET /api/admin/finance/xero/callback**
- Handles OAuth callback
- Exchanges code for tokens
- Stores connection
- Redirects to admin finance page

**POST /api/admin/finance/xero/sync**
- Manually triggers payment status sync
- Returns sync statistics

**GET /api/admin/finance/xero/invoice/:id**
- Gets Xero invoice status for a local invoice
- Returns Xero status, payment date, amount paid

---

## 6. Error Handling ✅

### Token Expiration
- ✅ Auto-refresh when within 5 minutes of expiration
- ✅ Connection marked as disconnected if refresh fails
- ✅ Clear error messages returned to UI

### Sync Failures
- ✅ Errors stored in `invoice.xeroSyncError`
- ✅ Sync errors don't block invoice updates
- ✅ Last sync time tracked even on errors
- ✅ Error count shown in connection status

### API Errors
- ✅ Xero API errors caught and logged
- ✅ User-friendly error messages returned
- ✅ Connection status reflects errors

---

## 7. Feature Flag ✅

**File:** `apps/web/src/config/features.js`

- ✅ `XERO_INTEGRATION_ENABLED: false` (default)
- ✅ All routes check feature flag
- ✅ Returns 503 when disabled

**Environment Variable:**
```bash
XERO_INTEGRATION_ENABLED=true
```

---

## 8. Invoice Creation Flow ✅

### Automatic Invoice Creation
**File:** `apps/api/src/services/deals/dealWorkflowService.ts`

When deal reaches "COMPLETED" stage:
1. ✅ Invoice created as "draft"
2. ✅ Invoice NOT pushed to Xero yet (draft status)
3. ✅ Invoice pushed when admin changes status to "sent" or "due"

### Manual Invoice Creation
**File:** `apps/api/src/routes/admin/finance.ts`

When admin creates invoice:
1. ✅ Invoice created as "draft"
2. ✅ Invoice NOT pushed to Xero yet
3. ✅ Invoice pushed when status changes from "draft"

---

## 9. Sync Lifecycle

### Invoice Lifecycle with Xero

```
1. Invoice Created (draft)
   └─> Stored locally only

2. Admin Changes Status to "sent" or "due"
   └─> pushInvoiceToXero() called
       ├─> Contact found/created in Xero
       ├─> Invoice created in Xero
       └─> xeroId stored in local invoice

3. Payment Received in Xero
   └─> Admin clicks "Sync" or cron runs
       └─> syncXeroPaymentStatuses() called
           ├─> Fetch status from Xero
           ├─> Check for payments
           └─> Update local invoice to "paid"

4. Status Updates
   └─> lastSyncedAt updated
   └─> xeroSyncError cleared on success
```

---

## 10. Testing Checklist

### OAuth Flow
- [ ] Connect button generates correct OAuth URL
- [ ] OAuth callback exchanges code successfully
- [ ] Connection stored in database
- [ ] Token refresh works automatically
- [ ] Connection status endpoint returns correct info

### Invoice Push
- [ ] Invoice pushed when status changes from draft
- [ ] Contact created in Xero if not exists
- [ ] Invoice created in Xero with correct data
- [ ] xeroId stored in local invoice
- [ ] Error handling works if push fails

### Payment Sync
- [ ] Sync fetches status from Xero
- [ ] Invoice status updated to "paid" when payment received
- [ ] paidAt timestamp set correctly
- [ ] lastSyncedAt updated
- [ ] Error handling works if sync fails

### Error Handling
- [ ] Expired tokens refresh automatically
- [ ] Sync errors stored in invoice
- [ ] Connection marked as disconnected on auth failure
- [ ] UI shows sync errors clearly

---

## 11. Environment Variables Required

```bash
# Feature flag
XERO_INTEGRATION_ENABLED=true

# OAuth credentials (from Xero Developer Portal)
XERO_CLIENT_ID=...
XERO_CLIENT_SECRET=...
XERO_REDIRECT_URI=https://yourdomain.com/api/admin/finance/xero/callback
```

**Xero Developer Portal Setup:**
1. Create app at https://developer.xero.com/myapps
2. Set redirect URI
3. Get Client ID and Secret
4. Request scopes: `accounting.transactions`, `accounting.contacts`, `offline_access`

---

## 12. Known Limitations

### Phase 2 Scope
- ⚠️ **Single Tenant** - Uses first tenant from connection (multi-tenant selection not implemented)
- ⚠️ **Account Code** - Uses hardcoded "200" for Sales (should be configurable)
- ⚠️ **No Auto-Sync** - Manual sync only (cron job not implemented)
- ⚠️ **No Webhooks** - Polling-based sync (Xero webhooks not implemented)

### Future Enhancements
- Multi-tenant selection
- Configurable account codes
- Automatic sync via cron
- Xero webhook integration
- Invoice line item details
- Credit notes support

---

## 13. Files Created/Modified

### Created
- `apps/api/src/services/xero/xeroAuth.ts` - OAuth flow
- `apps/api/src/services/xero/xeroService.ts` - API client
- `apps/api/src/services/xero/xeroInvoiceSync.ts` - Sync logic

### Modified
- `apps/api/prisma/schema.prisma` - Added xeroId, xeroSyncError, lastSyncedAt
- `apps/api/src/routes/admin/finance.ts` - Implemented Xero routes
- `apps/api/src/services/deals/dealWorkflowService.ts` - Added comment about Xero push

---

## 14. Admin UI Integration

### Connection Status
- Shows connection status in finance dashboard
- Displays tenant name and expiration
- Shows sync statistics

### Invoice List
- Displays Xero sync status
- Shows sync errors if any
- Indicates last sync time

### Sync Actions
- "Connect Xero" button triggers OAuth
- "Sync Now" button triggers manual sync
- Sync status displayed after sync

**Note:** UI updates are not included in Phase 2 - backend is ready for UI integration.

---

## Conclusion

Phase 2 is complete and ready for testing. All core functionality is implemented:
- ✅ OAuth connection with token management
- ✅ Invoice push to Xero
- ✅ Payment status sync
- ✅ Error handling
- ✅ Feature flag gating

The system is ready for OAuth credential configuration and testing.

