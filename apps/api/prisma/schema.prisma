generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---- Enums -----------------------------------------------------------------

enum Role {
  AGENT
  SELLER
  BUYER
  ADMIN
}

enum ContactType {
  SELLER
  BUYER
  MEMBER
  OTHER
}

enum ListingStatus {
  COMING_SOON
  ACTIVE
  UNDER_OFFER
  SOLD
  WITHDRAWN
}

enum ViewingStatus {
  REQUESTED
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum OfferStatus {
  RECEIVED
  NEGOTIATING
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum SaleStatus {
  MEMO_ISSUED
  SEARCHES
  ENQUIRIES
  MORTGAGE_OFFER
  EXCHANGE
  COMPLETION
  FALLTHROUGH
}

enum LetterStatus {
  DRAFT
  SENT
}

// ---- Models ----------------------------------------------------------------

model User {
  id        String   @id @default(cuid())
  role      Role
  name      String
  email     String   @unique
  phone     String?
  avatarUrl String?
  company   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contacts           Contact[]        @relation("ContactOwner")
  listingsNegotiated Listing[]        @relation("ListingNegotiator")
  viewingsCreated    Viewing[]        @relation("ViewingCreator")
  viewingsAttended   ViewingAttendee[]
  offersCreated      Offer[]          @relation("OfferCreator")
  tasksAssigned      Task[]           @relation("TaskAssignee")
  lettersSent        Letter[]         @relation("LetterSender")
  savedLists         SavedList[]
  documentsUploaded  Document[]

  @@map("users")
}

model Contact {
  id        String       @id @default(cuid())
  type      ContactType
  name      String
  emails    String[]     @db.Text
  phones    String[]     @db.Text
  address   Json?
  notes     String?
  tags      String[]     @db.Text
  source    String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  createdByUserId String?
  createdBy       User?         @relation("ContactOwner", fields: [createdByUserId], references: [id])

  listingsOwned Listing[] @relation("ListingOwner")
  offers        Offer[]   @relation("OfferBuyer")
  salesBuyer    Sale[]    @relation("SaleBuyer")

  viewingsAttended ViewingAttendee[]
  documents         Document[]
  lettersTo         Letter[]        @relation("LetterRecipient")

  @@index([type])
  @@map("contacts")
}

model Listing {
  id        String        @id @default(cuid())
  refCode   String        @unique
  status    ListingStatus @default(ACTIVE)
  address   Json
  priceGuide Int
  tenure    String?
  beds      Int
  baths     Int
  sqft      Int?
  features  String[]      @db.Text
  description String?
  media     Json?
  floorplans Json?
  epcUrl    String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  ownerContactId   String?
  ownerContact     Contact? @relation("ListingOwner", fields: [ownerContactId], references: [id])
  negotiatorUserId String?
  negotiator       User?    @relation("ListingNegotiator", fields: [negotiatorUserId], references: [id])

  viewings Viewing[]
  offers   Offer[]
  sale     Sale?
  documents Document[]
  letters   Letter[]

  @@index([status])
  @@map("listings")
}

model Viewing {
  id        String        @id @default(cuid())
  listingId String
  start     DateTime
  end       DateTime
  status    ViewingStatus @default(REQUESTED)
  notes     String?
  feedback  Json?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  createdByUserId String?
  createdBy       User?   @relation("ViewingCreator", fields: [createdByUserId], references: [id])
  listing         Listing @relation(fields: [listingId], references: [id])

  attendees ViewingAttendee[]

  @@index([listingId, start])
  @@index([start])
  @@map("viewings")
}

model ViewingAttendee {
  id         String   @id @default(cuid())
  viewingId  String
  contactId  String?
  userId     String?
  role       String? // e.g. BUYER, SELLER, AGENT
  createdAt  DateTime @default(now())

  viewing Viewing @relation(fields: [viewingId], references: [id])
  contact Contact? @relation(fields: [contactId], references: [id])
  user    User?    @relation(fields: [userId], references: [id])

  @@index([contactId])
  @@index([userId])
  @@map("viewing_attendees")
}

model Offer {
  id        String      @id @default(cuid())
  listingId String
  buyerContactId String
  amount    Decimal     @db.Decimal(12, 2)
  status    OfferStatus @default(RECEIVED)
  proofOfFundsUrl String?
  chainDetails Json?
  conditions String?
  timestamps Json?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  createdByUserId String?
  createdBy       User?    @relation("OfferCreator", fields: [createdByUserId], references: [id])
  listing         Listing  @relation(fields: [listingId], references: [id])
  buyer           Contact  @relation("OfferBuyer", fields: [buyerContactId], references: [id])

  sale Sale? @relation("SaleOffer")
  documents Document[]
  letters   Letter[]

  @@index([status])
  @@map("offers")
}

model Sale {
  id        String     @id @default(cuid())
  listingId String     @unique
  buyerContactId String?
  offerId    String?   @unique
  status     SaleStatus @default(MEMO_ISSUED)
  targetExchangeDate   DateTime?
  targetCompletionDate DateTime?
  milestoneDates Json?
  assignedConveyancerSeller Json?
  assignedConveyancerBuyer Json?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  listing Listing @relation(fields: [listingId], references: [id])
  buyer   Contact? @relation("SaleBuyer", fields: [buyerContactId], references: [id])
  offer   Offer?   @relation("SaleOffer", fields: [offerId], references: [id])

  documents Document[]
  letters   Letter[]

  @@map("sales")
}

model Task {
  id        String   @id @default(cuid())
  title     String
  dueAt     DateTime?
  status    String   @default("OPEN")
  linkedType String
  linkedId  String
  activityLog Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assigneeUserId String?
  assignee       User?    @relation("TaskAssignee", fields: [assigneeUserId], references: [id])

  @@index([linkedType, linkedId])
  @@map("tasks")
}

model LetterTemplate {
  id        String   @id @default(cuid())
  slug      String   @unique
  name      String
  mjmlBody  String
  variables String[] @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  letters Letter[]

  @@map("letter_templates")
}

model Letter {
  id            String       @id @default(cuid())
  templateId    String?
  toContactId   String?
  listingId     String?
  saleId        String?
  offerId       String?
  senderUserId  String?
  subject       String
  htmlBody      String
  status        LetterStatus @default(DRAFT)
  sentAt        DateTime?
  attachments   Json?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  template   LetterTemplate? @relation(fields: [templateId], references: [id])
  toContact  Contact?        @relation("LetterRecipient", fields: [toContactId], references: [id])
  listing    Listing?        @relation(fields: [listingId], references: [id])
  sale       Sale?           @relation(fields: [saleId], references: [id])
  offer      Offer?          @relation(fields: [offerId], references: [id])
  sender     User?           @relation("LetterSender", fields: [senderUserId], references: [id])

  @@index([status])
  @@map("letters")
}

model SavedList {
  id            String   @id @default(cuid())
  buyerUserId   String
  name          String
  items         String[] @db.Text
  sharedWithEmails String[] @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  buyer User @relation(fields: [buyerUserId], references: [id])

  @@map("saved_lists")
}

model Document {
  id        String   @id @default(cuid())
  entityType String
  entityId  String
  title     String
  url       String
  mime      String
  metadata  Json?
  uploadedByUserId String?
  contactId String?
  listingId String?
  offerId   String?
  saleId    String?
  createdAt DateTime @default(now())

  uploadedBy User?    @relation(fields: [uploadedByUserId], references: [id])
  contact    Contact? @relation(fields: [contactId], references: [id])
  listing    Listing? @relation(fields: [listingId], references: [id])
  offer      Offer?   @relation(fields: [offerId], references: [id])
  sale       Sale?    @relation(fields: [saleId], references: [id])

  @@index([entityType, entityId])
  @@map("documents")
}

model WebhookEvent {
  id          String   @id @default(cuid())
  provider    String
  eventType   String
  payload     Json
  processedAt DateTime?
  createdAt   DateTime @default(now())

  @@map("webhook_events")
}
