generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AgentProfile {
  id          String   @id
  userId      String   @unique
  agentType   String?
  bio         String?
  languages   String[]
  timezone    String?
  status      String   @default("active")
  maxCapacity Int      @default(10)
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AiTokenLog {
  id               String   @id
  userId           String?
  action           String
  model            String
  promptTokens     Int
  completionTokens Int
  totalTokens      Int
  estimatedCost    Float
  createdAt        DateTime @default(now())
  User             User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Brand {
  id                    String              @id
  name                  String              @unique
  values                String[]
  restrictedCategories  String[]
  preferredCreatorTypes String[]
  targetAudience        Json?
  Deal                  Deal[]
  SuitabilityResult     SuitabilityResult[]
}

model Deal {
  id                      String           @id
  userId                  String
  talentId                String
  brandId                 String
  stage                   DealStage        @default(NEW_LEAD)
  value                   Float?
  currency                String           @default("USD")
  brandName               String?
  aiSummary               String?
  notes                   String?
  expectedClose           DateTime?
  createdAt               DateTime         @default(now())
  updatedAt               DateTime
  campaignLiveAt          DateTime?
  closedAt                DateTime?
  contractReceivedAt      DateTime?
  contractSignedAt        DateTime?
  deliverablesCompletedAt DateTime?
  negotiationStartedAt    DateTime?
  proposalSentAt          DateTime?
  Brand                   Brand            @relation(fields: [brandId], references: [id], onDelete: Cascade)
  Talent                  Talent           @relation(fields: [talentId], references: [id], onDelete: Cascade)
  User                    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  DealNegotiation         DealNegotiation?
  DealTimeline            DealTimeline[]
  Deliverable             Deliverable[]
  Invoice                 Invoice[]
  Payment                 Payment[]
}

model DealNegotiation {
  id           String   @id
  dealId       String   @unique
  status       String   @default("pending")
  offerTerms   Json?
  counterTerms Json?
  history      Json[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  Deal         Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
}

model DealTimeline {
  id          String   @id
  dealId      String
  type        String
  message     String
  metadata    Json?
  createdById String?
  createdAt   DateTime @default(now())
  User        User?    @relation(fields: [createdById], references: [id])
  Deal        Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
}

model Deliverable {
  id              String    @id
  dealId          String
  title           String
  description     String?
  deliverableType String?
  usageRights     String?
  frequency       String?
  dueAt           DateTime?
  approvedAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  Deal            Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
}

model GmailToken {
  userId       String    @id
  accessToken  String
  refreshToken String
  expiryDate   DateTime?
  scope        String?
  tokenType    String?
  idToken      String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  User         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model InboundEmail {
  id                  String               @id
  userId              String?
  inboxMessageId      String?
  fromEmail           String
  toEmail             String
  subject             String?
  body                String?
  gmailId             String?              @unique
  threadId            String?
  receivedAt          DateTime             @default(now())
  direction           String               @default("inbound")
  isRead              Boolean              @default(false)
  categories          String[]
  metadata            Json?
  aiSummary           String?
  aiCategory          String?
  aiUrgency           String?
  aiRecommendedAction String?
  aiConfidence        Float?
  aiJson              Json?
  InboxMessage        InboxMessage?        @relation(fields: [inboxMessageId], references: [id], onDelete: Cascade)
  User                User?                @relation(fields: [userId], references: [id])
  TrackingPixelEvent  TrackingPixelEvent[]

  @@index([receivedAt])
  @@index([threadId])
  @@index([userId])
}

model InboxMessage {
  id              String           @id
  threadId        String           @unique
  userId          String
  subject         String?
  snippet         String?
  isRead          Boolean          @default(false)
  lastMessageAt   DateTime
  participants    String[]
  InboundEmail    InboundEmail[]
  InboxThreadMeta InboxThreadMeta?
}

model InboxThreadMeta {
  id              String       @id
  threadId        String       @unique
  userId          String
  aiThreadSummary String?
  unreadCount     Int          @default(0)
  priority        Int          @default(0)
  lastMessageAt   DateTime?
  linkedDealId    String?
  InboxMessage    InboxMessage @relation(fields: [threadId], references: [threadId])
}

model Invoice {
  id        String    @id
  dealId    String
  amount    Float
  status    String    @default("draft")
  issuedAt  DateTime
  dueAt     DateTime
  paidAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime
  Deal      Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String   @id
  userId    String
  title     String
  body      String?
  type      String
  entityId  String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Payment {
  id                  String    @id
  dealId              String
  talentId            String?
  amount              Float
  status              String    @default("PENDING")
  expectedPaymentDate DateTime?
  actualPaymentDate   DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime
  Deal                Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  Talent              Talent?   @relation(fields: [talentId], references: [id])
}

model RiskEvent {
  id         String   @id
  userId     String?
  entityType String
  entityId   String
  riskScore  Int
  riskFlags  String[]
  details    Json?
  createdAt  DateTime @default(now())
  User       User?    @relation(fields: [userId], references: [id])
}

model SuitabilityResult {
  id         String   @id
  creatorId  String
  brandId    String
  score      Int      @default(0)
  flags      String[]
  categories String[]
  reasoning  Json?
  aiSummary  String?
  createdAt  DateTime @default(now())
  Brand      Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  Talent     Talent   @relation(fields: [creatorId], references: [id], onDelete: Cascade)
}

model Talent {
  id                String              @id
  userId            String              @unique
  name              String
  categories        String[]
  stage             String?
  Deal              Deal[]
  Payment           Payment[]
  SuitabilityResult SuitabilityResult[]
  User              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  TalentAssignment  TalentAssignment[]
}

model TalentAssignment {
  id        String   @id
  agentId   String
  talentId  String
  createdAt DateTime @default(now())
  User      User     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  Talent    Talent   @relation(fields: [talentId], references: [id], onDelete: Cascade)

  @@unique([agentId, talentId])
}

model TrackingPixelEvent {
  id           String       @id
  emailId      String
  openedAt     DateTime     @default(now())
  ip           String?
  userAgent    String?
  InboundEmail InboundEmail @relation(fields: [emailId], references: [id], onDelete: Cascade)
}

model User {
  id                   String             @id
  email                String             @unique
  password             String?
  name                 String?
  avatarUrl            String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime
  upgrade_suggested    Boolean?           @default(false)
  include_in_roster    Boolean            @default(false)
  ugcApproved          Boolean            @default(false)
  ugcRates             Json?
  ugc_portfolio_url    String?
  ugc_categories       String[]           @default([])
  roster_category      String?
  subscriptionStatus   String?            @default("free")
  managedTalentIds     String[]           @default([])
  creator_score        Int?
  creator_score_reason Json?
  role_recommended     String?
  admin_notes          String?
  friends_of_house_id  String?
  onboarding_status    String?            @default("pending_review")
  location             String?
  timezone             String?
  pronouns             String?
  accountType          String?
  status               String?
  bio                  String?
  socialLinks          Json?
  onboardingComplete   Boolean?           @default(false)
  role                 String             @default("CREATOR")
  AgentProfile         AgentProfile?
  AiTokenLog           AiTokenLog[]
  Deal                 Deal[]
  DealTimeline         DealTimeline[]
  GmailToken           GmailToken?
  InboundEmail         InboundEmail[]
  Notification         Notification[]
  RiskEvent            RiskEvent[]
  Talent               Talent?
  TalentAssignment     TalentAssignment[]
}

enum DealStage {
  NEW_LEAD
  NEGOTIATION
  CONTRACT_SENT
  CONTRACT_SIGNED
  DELIVERABLES_IN_PROGRESS
  PAYMENT_PENDING
  PAYMENT_RECEIVED
  COMPLETED
  LOST
}

enum SocialPlatform {
  TIKTOK
  INSTAGRAM
  YOUTUBE
  X
  LINKEDIN
  FACEBOOK
  GMAIL
}

model Opportunity {
  id            String   @id @default(uuid())
  brand         String
  location      String
  title         String
  deliverables  String
  payment       String
  deadline      String
  status        String   @default("Live brief Â· Login required to apply")
  image         String
  logo          String
  type          String
  isActive      Boolean  @default(true)
  createdBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([isActive, createdAt])
  @@index([createdBy])
}
