generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AgentProfile {
  id          String   @id
  userId      String   @unique
  agentType   String?
  bio         String?
  languages   String[]
  timezone    String?
  status      String   @default("active")
  maxCapacity Int      @default(10)
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AiTokenLog {
  id               String   @id
  userId           String?
  action           String
  model            String
  promptTokens     Int
  completionTokens Int
  totalTokens      Int
  estimatedCost    Float
  createdAt        DateTime @default(now())
  User             User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Brand {
  id                    String              @id
  name                  String              @unique
  values                String[]
  restrictedCategories  String[]
  preferredCreatorTypes String[]
  targetAudience        Json?
  Deal                  Deal[]
  SuitabilityResult     SuitabilityResult[]
  LinkedOutreach        Outreach[]          @relation("OutreachLinkedBrand")
  Invoice               Invoice[]
  Payout                Payout[]
}

model Deal {
  id                      String              @id
  userId                  String
  talentId                String
  brandId                 String
  stage                   DealStage           @default(NEW_LEAD)
  value                   Float?
  currency                String              @default("USD")
  brandName               String?
  aiSummary               String?
  notes                   String?
  expectedClose           DateTime?
  opportunityId           String?             @unique
  createdAt               DateTime            @default(now())
  updatedAt               DateTime
  campaignLiveAt          DateTime?
  closedAt                DateTime?
  contractReceivedAt      DateTime?
  contractSignedAt        DateTime?
  deliverablesCompletedAt DateTime?
  negotiationStartedAt    DateTime?
  proposalSentAt          DateTime?
  Brand                   Brand               @relation(fields: [brandId], references: [id], onDelete: Cascade)
  Talent                  Talent              @relation(fields: [talentId], references: [id], onDelete: Cascade)
  User                    User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  Opportunity             SalesOpportunity?   @relation(fields: [opportunityId], references: [id])
  DealNegotiation         DealNegotiation?
  DealTimeline            DealTimeline[]
  Deliverable             Deliverable[]
  Invoice                 Invoice[]
  Payment                 Payment[]
  Payout                  Payout[]
  CreatorTask             CreatorTask[]

  @@index([opportunityId])
}

model DealNegotiation {
  id           String   @id
  dealId       String   @unique
  status       String   @default("pending")
  offerTerms   Json?
  counterTerms Json?
  history      Json[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  Deal         Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
}

model DealTimeline {
  id          String   @id
  dealId      String
  type        String
  message     String
  metadata    Json?
  createdById String?
  createdAt   DateTime @default(now())
  User        User?    @relation(fields: [createdById], references: [id])
  Deal        Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
}

model Deliverable {
  id              String        @id
  dealId          String
  title           String
  description     String?
  deliverableType String?
  usageRights     String?
  frequency       String?
  dueAt           DateTime?
  approvedAt      DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime
  Deal            Deal          @relation(fields: [dealId], references: [id], onDelete: Cascade)
  CreatorTask     CreatorTask[]
}

model GmailToken {
  userId       String    @id
  accessToken  String
  refreshToken String
  expiryDate   DateTime?
  scope        String?
  tokenType    String?
  idToken      String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  User         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model InboundEmail {
  id                  String               @id
  userId              String?
  inboxMessageId      String?
  fromEmail           String
  toEmail             String
  subject             String?
  body                String?
  gmailId             String?              @unique
  threadId            String?
  receivedAt          DateTime             @default(now())
  direction           String               @default("inbound")
  isRead              Boolean              @default(false)
  categories          String[]
  metadata            Json?
  aiSummary           String?
  aiCategory          String?
  aiUrgency           String?
  aiRecommendedAction String?
  aiConfidence        Float?
  aiJson              Json?
  InboxMessage        InboxMessage?        @relation(fields: [inboxMessageId], references: [id], onDelete: Cascade)
  User                User?                @relation(fields: [userId], references: [id])
  TrackingPixelEvent  TrackingPixelEvent[]

  @@index([receivedAt])
  @@index([threadId])
  @@index([userId])
}

model InboxMessage {
  id              String           @id
  threadId        String           @unique
  userId          String
  subject         String?
  snippet         String?
  isRead          Boolean          @default(false)
  lastMessageAt   DateTime
  participants    String[]
  InboundEmail    InboundEmail[]
  InboxThreadMeta InboxThreadMeta?
}

model InboxThreadMeta {
  id              String       @id
  threadId        String       @unique
  userId          String
  aiThreadSummary String?
  unreadCount     Int          @default(0)
  priority        Int          @default(0)
  lastMessageAt   DateTime?
  linkedDealId    String?
  InboxMessage    InboxMessage @relation(fields: [threadId], references: [threadId])
}

model Invoice {
  id            String    @id
  dealId        String
  brandId       String?
  invoiceNumber String    @unique
  amount        Float
  currency      String    @default("USD")
  status        String    @default("draft")
  issuedAt      DateTime
  dueAt         DateTime
  paidAt        DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime
  Deal          Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  Brand         Brand?    @relation(fields: [brandId], references: [id])

  @@index([dealId])
  @@index([brandId])
  @@index([status])
  @@index([dueAt])
}

model Notification {
  id        String   @id
  userId    String
  title     String
  body      String?
  type      String
  entityId  String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Payment {
  id                  String    @id
  dealId              String
  talentId            String?
  amount              Float
  status              String    @default("PENDING")
  expectedPaymentDate DateTime?
  actualPaymentDate   DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime
  Deal                Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  Talent              Talent?   @relation(fields: [talentId], references: [id])
}

model Payout {
  id               String    @id @default(uuid())
  creatorId        String
  dealId           String
  brandId          String?
  amount           Float
  currency         String    @default("USD")
  status           String    @default("pending")
  expectedPayoutAt DateTime?
  paidAt           DateTime?
  createdBy        String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  Creator          Talent    @relation("PayoutCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  Deal             Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  Brand            Brand?    @relation(fields: [brandId], references: [id])
  CreatedByUser    User?     @relation("PayoutCreatedBy", fields: [createdBy], references: [id])

  @@index([creatorId])
  @@index([dealId])
  @@index([brandId])
  @@index([status])
  @@index([expectedPayoutAt])
}

model FinanceReconciliation {
  id            String   @id @default(uuid())
  type          String
  referenceId   String
  amount        Float
  currency      String   @default("USD")
  method        String?
  notes         String?
  confirmedAt   DateTime
  createdBy     String
  createdAt     DateTime @default(now())
  CreatedByUser User     @relation(fields: [createdBy], references: [id])

  @@index([type])
  @@index([referenceId])
  @@index([confirmedAt])
}

model FinanceDocument {
  id             String   @id @default(uuid())
  fileUrl        String
  fileName       String?
  fileType       String
  linkedType     String
  linkedId       String
  uploadedBy     String
  uploadedAt     DateTime @default(now())
  UploadedByUser User     @relation(fields: [uploadedBy], references: [id])

  @@index([linkedType])
  @@index([linkedId])
  @@index([uploadedBy])
}

model FinanceActivityLog {
  id            String    @id @default(uuid())
  actionType    String
  referenceType String
  referenceId   String
  amount        Float?
  currency      String?
  metadata      Json?
  createdBy     String?
  createdAt     DateTime  @default(now())
  CreatedByUser User?     @relation(fields: [createdBy], references: [id])

  @@index([actionType])
  @@index([referenceType])
  @@index([referenceId])
  @@index([createdAt])
}

model XeroConnection {
  id           String    @id @default(uuid())
  connected    Boolean   @default(false)
  tenantId     String?
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  lastSyncedAt DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model RiskEvent {
  id         String   @id
  userId     String?
  entityType String
  entityId   String
  riskScore  Int
  riskFlags  String[]
  details    Json?
  createdAt  DateTime @default(now())
  User       User?    @relation(fields: [userId], references: [id])
}

model SuitabilityResult {
  id         String   @id
  creatorId  String
  brandId    String
  score      Int      @default(0)
  flags      String[]
  categories String[]
  reasoning  Json?
  aiSummary  String?
  createdAt  DateTime @default(now())
  Brand      Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  Talent     Talent   @relation(fields: [creatorId], references: [id], onDelete: Cascade)
}

model Talent {
  id                      String                    @id
  userId                  String                    @unique
  name                    String
  categories              String[]
  stage                   String?
  Deal                    Deal[]
  Payment                 Payment[]
  SuitabilityResult       SuitabilityResult[]
  User                    User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  TalentAssignment        TalentAssignment[]
  Payout                  Payout[]                  @relation("PayoutCreator")
  CreatorGoal             CreatorGoal[]
  CreatorEvent            CreatorEvent[]
  SocialAccountConnection SocialAccountConnection[]
  CreatorInsight          CreatorInsight[]
  CreatorTask             CreatorTask[]
  WellnessCheckin         WellnessCheckin[]
  AIPromptHistory         AIPromptHistory[]
}

model TalentAssignment {
  id        String   @id
  agentId   String
  talentId  String
  createdAt DateTime @default(now())
  User      User     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  Talent    Talent   @relation(fields: [talentId], references: [id], onDelete: Cascade)

  @@unique([agentId, talentId])
}

model TrackingPixelEvent {
  id           String       @id
  emailId      String
  openedAt     DateTime     @default(now())
  ip           String?
  userAgent    String?
  InboundEmail InboundEmail @relation(fields: [emailId], references: [id], onDelete: Cascade)
}

model User {
  id                      String                  @id
  email                   String                  @unique
  password                String?
  name                    String?
  avatarUrl               String?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime
  upgrade_suggested       Boolean?                @default(false)
  include_in_roster       Boolean                 @default(false)
  ugcApproved             Boolean                 @default(false)
  ugcRates                Json?
  ugc_portfolio_url       String?
  ugc_categories          String[]                @default([])
  roster_category         String?
  subscriptionStatus      String?                 @default("free")
  managedTalentIds        String[]                @default([])
  creator_score           Int?
  creator_score_reason    Json?
  role_recommended        String?
  admin_notes             String?
  friends_of_house_id     String?
  onboarding_status       String?                 @default("pending_review")
  location                String?
  timezone                String?
  pronouns                String?
  accountType             String?
  status                  String?
  bio                     String?
  socialLinks             Json?
  onboardingComplete      Boolean?                @default(false)
  role                    String                  @default("CREATOR")
  AgentProfile            AgentProfile?
  AiTokenLog              AiTokenLog[]
  Deal                    Deal[]
  DealTimeline            DealTimeline[]
  GmailToken              GmailToken?
  InboundEmail            InboundEmail[]
  Notification            Notification[]
  RiskEvent               RiskEvent[]
  Talent                  Talent?
  TalentAssignment        TalentAssignment[]
  Resource                Resource[]
  File                    File[]
  Outreach                Outreach[]
  LinkedOutreachAsCreator Outreach[]              @relation("OutreachLinkedCreator")
  PayoutsCreated          Payout[]                @relation("PayoutCreatedBy")
  ReconciliationsCreated  FinanceReconciliation[]
  DocumentsUploaded       FinanceDocument[]
  FinanceActivityLogs     FinanceActivityLog[]
  EventsCreated           CreatorEvent[]          @relation("EventCreatedBy")
  TasksCreated            CreatorTask[]           @relation("TaskCreatedBy")
}

enum DealStage {
  NEW_LEAD
  NEGOTIATION
  CONTRACT_SENT
  CONTRACT_SIGNED
  DELIVERABLES_IN_PROGRESS
  PAYMENT_PENDING
  PAYMENT_RECEIVED
  COMPLETED
  LOST
}

enum SocialPlatform {
  TIKTOK
  INSTAGRAM
  YOUTUBE
  X
  LINKEDIN
  FACEBOOK
  GMAIL
}

model Opportunity {
  id           String   @id @default(uuid())
  brand        String
  location     String
  title        String
  deliverables String
  payment      String
  deadline     String
  status       String   @default("Live brief Â· Login required to apply")
  image        String
  logo         String
  type         String
  isActive     Boolean  @default(true)
  createdBy    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isActive, createdAt])
  @@index([createdBy])
}

model Resource {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  type        String
  audience    String
  protected   Boolean  @default(false)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([type, audience])
  @@index([createdById])
}

model File {
  id        String   @id @default(uuid())
  userId    String?
  key       String
  url       String?
  filename  String
  type      String
  folder    String?
  size      Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([folder])
}

model Outreach {
  id                 String                 @id @default(uuid())
  target             String
  type               String                 @default("Brand")
  contact            String?
  contactEmail       String?
  link               String?
  owner              String?
  source             String?
  stage              String                 @default("not-started")
  status             String                 @default("Not started")
  summary            String?
  threadUrl          String?
  gmailThreadId      String?
  emailsSent         Int                    @default(0)
  emailsReplies      Int                    @default(0)
  lastContact        DateTime?
  nextFollowUp       DateTime?
  reminder           String?
  opportunityRef     String?
  archived           Boolean                @default(false)
  linkedCreatorId    String?
  linkedBrandId      String?
  createdBy          String
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  User               User                   @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  LinkedCreator      User?                  @relation("OutreachLinkedCreator", fields: [linkedCreatorId], references: [id])
  LinkedBrand        Brand?                 @relation("OutreachLinkedBrand", fields: [linkedBrandId], references: [id])
  OutreachNote       OutreachNote[]
  OutreachTask       OutreachTask[]
  OutreachEmailThread OutreachEmailThread[]
  SalesOpportunity   SalesOpportunity?

  @@index([createdBy])
  @@index([stage])
  @@index([gmailThreadId])
  @@index([nextFollowUp])
  @@index([archived])
  @@index([linkedCreatorId])
  @@index([linkedBrandId])
}

model OutreachNote {
  id          String   @id @default(uuid())
  outreachId  String
  author      String
  body        String
  createdAt   DateTime @default(now())
  Outreach    Outreach @relation(fields: [outreachId], references: [id], onDelete: Cascade)

  @@index([outreachId])
  @@index([createdAt])
}

model OutreachTask {
  id          String   @id @default(uuid())
  outreachId  String
  title       String
  dueDate     DateTime?
  owner       String?
  priority    String   @default("Medium")
  status      String   @default("Open")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  Outreach    Outreach @relation(fields: [outreachId], references: [id], onDelete: Cascade)

  @@index([outreachId])
  @@index([dueDate])
  @@index([status])
}

model OutreachEmailThread {
  id              String   @id @default(uuid())
  outreachId      String
  gmailThreadId   String   @unique
  lastMessageAt   DateTime
  status          String   @default("awaiting_reply")
  lastSyncedAt    DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  Outreach        Outreach @relation(fields: [outreachId], references: [id], onDelete: Cascade)

  @@index([outreachId])
  @@index([gmailThreadId])
  @@index([status])
}

model SalesOpportunity {
  id              String    @id @default(uuid())
  outreachId      String    @unique
  name            String
  value           Float
  currency        String    @default("USD")
  expectedCloseAt DateTime?
  status          String    @default("open")
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  Outreach        Outreach  @relation(fields: [outreachId], references: [id], onDelete: Cascade)
  Deal            Deal?

  @@index([outreachId])
  @@index([status])
  @@index([expectedCloseAt])
}

// ============================================
// EXCLUSIVE TALENT CREATOR-SAFE MODELS
// ============================================

model CreatorGoal {
  id          String   @id @default(uuid())
  creatorId   String
  goalType    String   // revenue | product | events | personal | content
  title       String
  targetValue Float?
  timeframe   String?  // Q1 2024 | 6 months | etc
  progress    Float    @default(0) // 0-1 decimal
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  Creator     Talent   @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId, active])
  @@index([goalType])
}

model CreatorEvent {
  id            String    @id @default(uuid())
  creatorId     String
  eventName     String
  eventType     String    // meeting | shoot | launch | appearance
  description   String?
  location      String?
  startAt       DateTime
  endAt         DateTime?
  status        String    @default("suggested") // suggested | invited | accepted | declined
  source        String    @default("agent") // agent | admin | system
  sourceUserId  String?
  declineReason String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  Creator       Talent    @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  SourceUser    User?     @relation("EventCreatedBy", fields: [sourceUserId], references: [id])

  @@index([creatorId, status])
  @@index([startAt])
  @@index([status])
}

model SocialAccountConnection {
  id           String    @id @default(uuid())
  creatorId    String
  platform     String    // instagram | tiktok | youtube | x | linkedin
  handle       String
  connected    Boolean   @default(false)
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  lastSyncedAt DateTime?
  metadata     Json?     // Platform-specific data
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  Creator      Talent    @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@unique([creatorId, platform])
  @@index([creatorId, connected])
  @@index([platform])
}

model CreatorInsight {
  id          String    @id @default(uuid())
  creatorId   String
  insightType String    // performance | trend | audience | opportunity
  title       String
  summary     String
  context     String?   // Additional context/explanation
  metadata    Json?     // Any supporting data
  priority    Int       @default(0)
  isRead      Boolean   @default(false)
  createdAt   DateTime  @default(now())
  expiresAt   DateTime? // Optional expiry for time-sensitive insights
  Creator     Talent    @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId, isRead])
  @@index([creatorId, createdAt])
  @@index([insightType])
}

model CreatorTask {
  id                  String       @id @default(uuid())
  creatorId           String
  title               String
  description         String?
  taskType            String       // creative | attendance | review | approval
  dueAt               DateTime?
  completedAt         DateTime?
  priority            String       @default("medium") // low | medium | high | urgent
  status              String       @default("pending") // pending | in_progress | completed | cancelled
  linkedDealId        String?
  linkedDeliverableId String?
  createdBy           String?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  Creator             Talent       @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  Deal                Deal?        @relation(fields: [linkedDealId], references: [id])
  Deliverable         Deliverable? @relation(fields: [linkedDeliverableId], references: [id])
  CreatedByUser       User?        @relation("TaskCreatedBy", fields: [createdBy], references: [id])

  @@index([creatorId, status])
  @@index([creatorId, dueAt])
  @@index([linkedDealId])
  @@index([priority])
}

model WellnessCheckin {
  id          String   @id @default(uuid())
  creatorId   String
  energyLevel Int      // 1-5 scale
  workload    String   // light | comfortable | busy | overwhelming
  notes       String?
  createdAt   DateTime @default(now())
  Creator     Talent   @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId, createdAt])
}

model AIPromptHistory {
  id        String   @id @default(uuid())
  creatorId String
  prompt    String
  response  String
  category  String?  // content_ideas | career_advice | scheduling | general
  helpful   Boolean? // Optional feedback
  createdAt DateTime @default(now())
  Creator   Talent   @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId, createdAt])
  @@index([category])
}
