# V1.1 Deal Negotiation Intelligence - Phase 5 Implementation

**Date:** January 2025  
**Status:** ✅ Complete - Ready for Testing

---

## Overview

Phase 5 implements AI-powered deal negotiation intelligence that analyzes historical deals, brand benchmarks, and talent performance to suggest optimal negotiation parameters. All intelligence is read-only (no auto-negotiation) and gated behind `DEAL_INTELLIGENCE_ENABLED`.

---

## 1. Data Inputs ✅

### Historical Deal Values

**Source:** `Deal` table
- Filters: `talentId` matches, `stage` in `["PAYMENT_RECEIVED", "COMPLETED"]`, `value` not null
- Returns: Last 20 closed deals with values, currencies, brand IDs, close dates
- Used for: Calculating average, min, max historical values

**Implementation:**
```typescript
async function getHistoricalDealValues(talentId: string) {
  const historicalDeals = await prisma.deal.findMany({
    where: {
      talentId,
      stage: { in: ["PAYMENT_RECEIVED", "COMPLETED"] },
      value: { not: null }
    },
    orderBy: { closedAt: "desc" },
    take: 20
  });
  return historicalDeals;
}
```

### Brand Category Benchmarks

**Source:** `Brand` table + `Deal` table
- Gets brand info: name, values, restrictedCategories, preferredCreatorTypes
- Gets other deals with same brand: Last 10 closed deals
- Calculates: Average deal value with this brand
- Used for: Understanding brand spending patterns

**Implementation:**
```typescript
async function getBrandCategoryInfo(brandId: string) {
  const brand = await prisma.brand.findUnique({ where: { id: brandId } });
  const brandDeals = await prisma.deal.findMany({
    where: { brandId, stage: { in: ["PAYMENT_RECEIVED", "COMPLETED"] } }
  });
  return { brand, brandDeals };
}
```

### Talent Performance Data

**Source:** `SocialAccountConnection` + `SocialProfile`
- Gets connected social accounts for talent
- Aggregates: Total followers, average engagement rate, total posts, platform count
- Used for: Assessing talent's market value based on reach and engagement

**Implementation:**
```typescript
async function getTalentPerformanceData(talentId: string) {
  const connections = await prisma.socialAccountConnection.findMany({
    where: { creatorId: talentId, connected: true },
    include: { SocialProfile: true }
  });
  // Calculate aggregate metrics
  return { totalFollowers, avgEngagementRate, totalPosts, platformCount };
}
```

---

## 2. AI Outputs ✅

### Suggested Deal Value Range

**Structure:**
```typescript
{
  min: number,    // Minimum recommended value
  ideal: number,  // Ideal target value
  max: number     // Maximum recommended value
}
```

**Calculation:**
- Uses historical average as baseline
- AI adjusts based on brand benchmarks and talent performance
- Fallback: `min = avg * 0.8`, `ideal = avg * 1.2`, `max = avg * 1.5`

### Negotiation Confidence Score

**Range:** 0-100
- **High (70-100):** Strong historical data + brand data + talent metrics
- **Medium (40-69):** Some data available but gaps exist
- **Low (0-39):** Limited data, recommendations less reliable

**Factors:**
- Number of historical deals (more = higher confidence)
- Brand-specific deal history (more = higher confidence)
- Talent performance data completeness
- Data recency

### Explanation Text

**Format:** 2-3 sentence explanation of the recommendation
- Explains the value range rationale
- Mentions key factors (historical, brand, talent)
- Acknowledges limitations if data is sparse

### Reasoning Breakdown

**Structure:**
```typescript
{
  historicalBenchmark: string,    // How historical deals inform recommendation
  brandCategoryBenchmark: string, // How brand category informs recommendation
  talentPerformance: string,       // How talent metrics inform recommendation
  riskFactors: string[]            // Any risk factors to consider
}
```

---

## 3. AI Prompt Logic ✅

### Prompt Structure

**System Message:**
- Role: Expert talent agent AI assistant
- Instruction: Always return valid JSON only, no markdown

**User Prompt Includes:**
1. Current deal context (ID, brand, value, stage, currency)
2. Historical deal data (averages, ranges, recent deals)
3. Brand category benchmarks (average spend, brand values)
4. Talent performance metrics (followers, engagement, posts)

**Output Schema:**
```json
{
  "suggestedValueRange": { "min": number, "ideal": number, "max": number },
  "confidenceScore": number (0-100),
  "explanation": "string",
  "reasoning": {
    "historicalBenchmark": "string",
    "brandCategoryBenchmark": "string",
    "talentPerformance": "string",
    "riskFactors": ["string"]
  }
}
```

### Confidence Scoring Explanation

**Formula (Conceptual):**
```
Base Confidence = 40

+ Historical Data Bonus:
  - 1-5 deals: +10
  - 6-10 deals: +20
  - 11+ deals: +30

+ Brand Data Bonus:
  - 1-3 brand deals: +10
  - 4+ brand deals: +20

+ Talent Performance Bonus:
  - Complete social data: +10
  - Partial social data: +5

Maximum: 100
```

**AI Adjusts:**
- AI can adjust confidence based on data quality
- Lower confidence if data is stale or incomplete
- Higher confidence if patterns are consistent

---

## 4. API Endpoints ✅

### POST /api/deals/intelligence/run/:dealId

**Purpose:** Generate or regenerate AI intelligence for a deal

**Access:** Deal owner or Admin

**Response:**
```json
{
  "success": true,
  "intelligence": {
    "suggestedValueRange": { "min": 5000, "ideal": 7500, "max": 10000 },
    "confidenceScore": 75,
    "explanation": "...",
    "reasoning": { ... },
    "id": "intel_...",
    "generatedAt": "2025-01-15T10:00:00Z"
  }
}
```

### GET /api/deals/intelligence/:dealId

**Purpose:** Retrieve existing intelligence for a deal

**Access:** Deal owner or Admin

**Response:**
```json
{
  "success": true,
  "intelligence": {
    "id": "intel_...",
    "dealId": "deal_...",
    "suggestedValueRange": { ... },
    "confidenceScore": 75,
    "explanation": "...",
    "reasoning": { ... },
    "riskFlags": [],
    "generatedAt": "2025-01-15T10:00:00Z",
    "updatedAt": "2025-01-15T10:00:00Z"
  }
}
```

**Error Handling:**
- 404 if deal not found
- 404 if intelligence not found (with message to generate)
- 403 if user doesn't have access
- 503 if feature disabled

---

## 5. UI Integration ✅

### DealAIPanel Component

**File:** `apps/web/src/components/DealAIPanel.jsx`

**Changes:**
- ✅ "Get Insights" button enabled (removed disabled state)
- ✅ Calls `/api/deals/intelligence/run/:dealId` to generate
- ✅ Falls back to GET if intelligence already exists
- ✅ Displays structured intelligence response

**UI Elements:**
1. **Value Range Cards:**
   - Minimum (gray card)
   - Ideal (red highlight)
   - Maximum (gray card)

2. **Confidence Score:**
   - Percentage display
   - Progress bar visualization

3. **Explanation:**
   - 2-3 sentence recommendation text

4. **Reasoning Breakdown:**
   - Historical Benchmark section
   - Brand Category section
   - Talent Performance section
   - Risk Factors (if any)

**Error Handling:**
- Shows error message if API fails
- Handles 503 (feature disabled) gracefully
- Shows loading state during generation

---

## 6. Feature Flag ✅

### Backend

**File:** `apps/api/src/config/features.ts`
- ✅ `DEAL_INTELLIGENCE_ENABLED: process.env.DEAL_INTELLIGENCE_ENABLED === "true"`

**File:** `apps/api/src/routes/dealIntelligence.ts`
- ✅ All routes check feature flag via middleware
- ✅ Returns 503 if disabled

### Frontend

**File:** `apps/web/src/config/features.js`
- ✅ `DEAL_INTELLIGENCE_ENABLED: true` (enabled)

**Environment Variable:**
```bash
DEAL_INTELLIGENCE_ENABLED=true
```

---

## 7. Files Created/Modified

### Created
- `apps/api/src/services/dealIntelligenceService.ts` - Core intelligence service

### Modified
- `apps/api/src/routes/dealIntelligence.ts` - Enhanced with AI integration
- `apps/api/src/server.ts` - Mounted dealIntelligence router
- `apps/web/src/components/DealAIPanel.jsx` - Enabled "Get Insights" button
- `apps/web/src/config/features.js` - Added feature flag

---

## 8. Data Flow

```
1. User Clicks "Get Insights"
   └─> Frontend calls POST /api/deals/intelligence/run/:dealId

2. Backend Service Collects Data
   ├─> getHistoricalDealValues(talentId)
   ├─> getBrandCategoryInfo(brandId)
   └─> getTalentPerformanceData(talentId)

3. AI Analysis
   └─> OpenAI API called with comprehensive prompt
       ├─> Historical benchmarks
       ├─> Brand category data
       └─> Talent performance metrics

4. Response Structure
   └─> Returns: value range, confidence, explanation, reasoning

5. Storage
   └─> Saved to DealIntelligence table
       └─> Future GET requests return cached result

6. UI Display
   └─> DealAIPanel renders structured intelligence
       ├─> Value range cards
       ├─> Confidence score bar
       ├─> Explanation text
       └─> Reasoning breakdown
```

---

## 9. Constraints Enforced ✅

### No Auto-Negotiation
- ✅ Intelligence is read-only
- ✅ No automatic counter-offers
- ✅ No automatic deal updates
- ✅ User must manually act on recommendations

### AI Must Explain Reasoning
- ✅ Explanation text provided
- ✅ Reasoning breakdown includes:
  - Historical benchmark explanation
  - Brand category explanation
  - Talent performance explanation
  - Risk factors listed

### Feature Gated
- ✅ All routes check `DEAL_INTELLIGENCE_ENABLED`
- ✅ Returns 503 if disabled
- ✅ Frontend feature flag exists

---

## 10. Testing Checklist

### Data Collection
- [ ] Historical deals retrieved correctly
- [ ] Brand category info retrieved correctly
- [ ] Talent performance data retrieved correctly
- [ ] Handles missing data gracefully

### AI Generation
- [ ] AI prompt includes all data inputs
- [ ] AI returns valid JSON structure
- [ ] Fallback works if AI unavailable
- [ ] Confidence score calculated correctly

### API Endpoints
- [ ] POST /api/deals/intelligence/run/:dealId generates intelligence
- [ ] GET /api/deals/intelligence/:dealId returns existing intelligence
- [ ] Feature flag gating works
- [ ] Access control enforced (deal owner or admin)

### UI Integration
- [ ] "Get Insights" button enabled
- [ ] Intelligence displays correctly
- [ ] Value range cards show correct values
- [ ] Confidence score bar renders
- [ ] Reasoning breakdown displays
- [ ] Error handling works

---

## 11. Known Limitations

### Phase 5 Scope
- ⚠️ **No Auto-Negotiation** - Intelligence is advisory only
- ⚠️ **No Auto-Updates** - Deal values must be updated manually
- ⚠️ **No Historical Backfill** - Only analyzes existing deals
- ⚠️ **No Market Data** - Uses internal data only

### Future Enhancements
- Industry benchmark integration
- Competitive analysis
- Multi-talent comparisons
- Negotiation strategy suggestions
- Email draft generation based on intelligence

---

## Conclusion

Phase 5 is complete and ready for testing. All core functionality is implemented:
- ✅ Data inputs collected (historical, brand, talent)
- ✅ AI outputs generated (value range, confidence, explanation)
- ✅ UI integration complete ("Get Insights" enabled)
- ✅ Feature flag gating
- ✅ No auto-negotiation (read-only)
- ✅ AI explains reasoning

The system is ready for deal intelligence generation and negotiation support.

