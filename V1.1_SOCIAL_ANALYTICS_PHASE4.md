# V1.1 Social Analytics - Phase 4 Implementation

**Date:** January 2025  
**Status:** ✅ Complete - Ready for Testing

---

## Overview

Phase 4 reintroduces social analytics with real data ingestion, time-series storage, and dashboard integration. All analytics are read-only and gated behind `SOCIAL_ANALYTICS_ENABLED`.

---

## 1. Schema Verification ✅

### Existing Models (No Changes Required)

The schema already contains all necessary models:

- ✅ **SocialAccountConnection** - OAuth connections
- ✅ **SocialProfile** - Profile snapshots (followers, bio, metrics)
- ✅ **SocialPost** - Individual posts/videos with engagement
- ✅ **SocialMetric** - Time-series metrics (follower_count, engagement_rate, etc.)
- ✅ **SocialSyncLog** - Sync operation logs

**No schema changes required** - models are production-ready.

---

## 2. Data Ingestion ✅

### Enhanced Sync Services

**Instagram Sync** (`InstagramSyncService.js`):
- ✅ Stores follower_count, following_count, post_count metrics
- ✅ Stores engagement_rate metrics per post
- ✅ Uses `createMany` for efficient batch inserts

**TikTok Sync** (`TikTokSyncService.js`):
- ✅ Stores follower_count, following_count, likes_count metrics
- ✅ Stores engagement_rate metrics per video
- ✅ Handles TikTok-specific metadata

**YouTube Sync** (`YouTubeSyncService.js`):
- ✅ Updated to use connectionId-based schema
- ✅ Stores follower_count, post_count, total_views metrics
- ✅ Stores engagement_rate metrics per video
- ✅ Fixed method signature (removed userId parameter)

### Metrics Stored

**Profile Metrics** (stored on each profile sync):
- `follower_count` - Current follower count
- `following_count` - Current following count (Instagram/TikTok)
- `post_count` - Total posts/videos
- `total_views` - Total views (YouTube)

**Post Metrics** (stored on each post sync):
- `engagement_rate` - Calculated per post/video
- Metadata includes: likes, comments, shares, views

---

## 3. Analytics Endpoints ✅

### Enhanced Routes

**File:** `apps/api/src/routes/analytics/socials.ts`

#### GET /api/analytics/socials
- Returns aggregated metrics across all platforms
- Includes: totalFollowers, totalPosts, totalEngagement
- Lists all platforms with current metrics
- Returns recent posts (top 10)

#### GET /api/analytics/socials/:platform
- Returns detailed analytics for specific platform
- Includes: profile info, posts, engagement metrics
- Returns time-series metrics (last 30 by default)

#### GET /api/analytics/socials/:platform/metrics
- Returns time-series metrics for a platform
- Query params: `metricType`, `days` (default 30)
- Supports filtering by metric type

#### GET /api/analytics/socials/connections
- Returns all connected social accounts
- Includes profile metrics (followerCount, postCount, engagementRate)

### New Routes

**File:** `apps/api/src/routes/analytics/topPosts.ts`

#### GET /api/analytics/top-posts
- Returns top performing posts across all platforms
- Sorted by engagement rate
- Query param: `limit` (default 5)

### Router Integration

**File:** `apps/api/src/routes/analytics.ts`
- ✅ Mounted `socialsRouter` at `/socials`
- ✅ Mounted `topPostsRouter` at `/top-posts`
- ✅ Removed placeholder `/socials` route

---

## 4. Feature Flags ✅

**File:** `apps/web/src/config/features.js`

- ✅ `SOCIAL_ANALYTICS_ENABLED: true` (enabled)
- ✅ All routes check feature flag
- ✅ Returns 503 when disabled

**Environment Variable:**
```bash
SOCIAL_ANALYTICS_ENABLED=true
```

---

## 5. Data Flow

```
1. User Connects Social Account
   └─> OAuth flow → Store tokens in SocialAccountConnection

2. Sync Job Runs (Daily Cron)
   └─> socialRefreshProcessor
       ├─> syncProfile() → Update SocialProfile + Store metrics
       └─> syncPosts() → Update SocialPost + Store engagement metrics

3. Frontend Requests Analytics
   └─> GET /api/analytics/socials
       ├─> Query SocialAccountConnection (connected: true)
       ├─> Include SocialProfile with posts
       ├─> Aggregate metrics
       └─> Return real data

4. Time-Series Queries
   └─> GET /api/analytics/socials/:platform/metrics
       ├─> Query SocialMetric by profileId
       ├─> Filter by metricType and date range
       └─> Return time-series array
```

---

## 6. Metrics Storage

### Metric Types

**Profile Metrics:**
- `follower_count` - Stored on profile sync
- `following_count` - Stored on profile sync (Instagram/TikTok)
- `post_count` - Stored on profile sync
- `total_views` - Stored on profile sync (YouTube)

**Post Metrics:**
- `engagement_rate` - Stored on post sync (per post)

### Storage Pattern

```typescript
// Profile sync
await prisma.socialMetric.createMany({
  data: [
    { metricType: 'follower_count', value: 45000, snapshotDate: now },
    { metricType: 'following_count', value: 1200, snapshotDate: now },
    { metricType: 'post_count', value: 150, snapshotDate: now }
  ]
});

// Post sync
await prisma.socialMetric.create({
  data: {
    metricType: 'engagement_rate',
    value: 3.2,
    snapshotDate: now,
    metadata: { postId, likes, comments, views }
  }
});
```

---

## 7. UI Integration Notes

### Existing Components

The following components are ready to consume real data:

- ✅ `SocialAnalyticsPanel` - Uses `/api/analytics/socials`
- ✅ `TopPerformingPosts` - Uses `/api/analytics/top-posts`
- ✅ `ExclusiveSocialPanel` - Uses `/api/analytics/socials/connections`
- ✅ `ExclusiveAnalytics` - Uses `useSocials()` hook

### Data Format

**Aggregated Analytics:**
```json
{
  "success": true,
  "data": {
    "totalFollowers": 105000,
    "totalPosts": 150,
    "totalEngagement": 45000,
    "platforms": [
      {
        "platform": "instagram",
        "handle": "@username",
        "followerCount": 45000,
        "postCount": 75,
        "engagementRate": 3.2
      }
    ],
    "recentPosts": [...]
  }
}
```

**Time-Series Metrics:**
```json
{
  "success": true,
  "data": {
    "platform": "instagram",
    "metrics": [
      {
        "metricType": "follower_count",
        "value": 45000,
        "snapshotDate": "2025-01-15T10:00:00Z"
      }
    ]
  }
}
```

---

## 8. Files Created/Modified

### Created
- `apps/api/src/routes/analytics/topPosts.ts` - Top posts endpoint

### Modified
- `apps/api/src/routes/analytics/socials.ts` - Enhanced with real data
- `apps/api/src/routes/analytics.ts` - Mounted new routes
- `apps/api/src/services/instagram/InstagramSyncService.js` - Enhanced metrics storage
- `apps/api/src/services/tiktok/TikTokSyncService.js` - Enhanced metrics storage
- `apps/api/src/services/youtube/YouTubeSyncService.js` - Fixed schema usage
- `apps/api/src/worker/processors/socialRefreshProcessor.ts` - Fixed YouTube method call
- `apps/web/src/config/features.js` - Enabled feature flag

---

## 9. Testing Checklist

### Data Ingestion
- [ ] Profile sync stores follower_count metric
- [ ] Post sync stores engagement_rate metric
- [ ] Metrics stored with correct snapshotDate
- [ ] No duplicate metrics created

### Analytics Endpoints
- [ ] `/api/analytics/socials` returns real data
- [ ] `/api/analytics/socials/:platform` returns platform-specific data
- [ ] `/api/analytics/socials/:platform/metrics` returns time-series
- [ ] `/api/analytics/top-posts` returns top posts
- [ ] Feature flag gating works correctly

### UI Integration
- [ ] SocialAnalyticsPanel displays real follower counts
- [ ] TopPerformingPosts shows real posts
- [ ] Charts populate with time-series data
- [ ] Empty states show when no data

---

## 10. Known Limitations

### Phase 4 Scope
- ⚠️ **Read-Only Analytics** - No predictions or AI summaries (as requested)
- ⚠️ **No Aggregations** - Time-series metrics stored per sync, not aggregated
- ⚠️ **No Historical Backfill** - Only stores metrics going forward

### Future Enhancements
- Daily/weekly aggregations
- Growth rate calculations
- Engagement trend analysis
- AI-powered insights
- Comparative analytics (vs. industry benchmarks)

---

## Conclusion

Phase 4 is complete and ready for testing. All core functionality is implemented:
- ✅ Schema verified (no changes needed)
- ✅ Data ingestion enhanced (stores time-series metrics)
- ✅ Analytics endpoints return real data
- ✅ Feature flag gating
- ✅ Top posts endpoint
- ✅ Time-series metrics endpoint

The system is ready for social account connections and data syncing.

