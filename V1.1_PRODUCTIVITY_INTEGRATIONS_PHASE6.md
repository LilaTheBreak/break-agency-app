# V1.1 Productivity Integrations - Phase 6 Implementation

**Date:** January 2025  
**Status:** ✅ Complete - Ready for Testing

---

## Overview

Phase 6 implements optional productivity integrations for Slack, Notion, and Google Drive. All integrations are:
- **One-way sync only** (Break Agency → External tool)
- **Fully optional** (gracefully degrade if disconnected)
- **Feature-flagged** (can be disabled via environment variables)

---

## 1. Slack Integration ✅

### Purpose
Send notifications for:
- Deal status changes
- Invoice creation
- Approval requests

### Implementation

**Service:** `apps/api/src/services/integrations/slackService.ts`

**Connection Method:** Webhook URL (no OAuth required)

**Functions:**
- `sendSlackNotification(userId, notification)` - Generic notification sender
- `notifyDealUpdate(userId, deal)` - Deal status change notifications
- `notifyInvoiceCreated(userId, invoice)` - Invoice creation notifications
- `notifyApprovalRequired(userId, approval)` - Approval request notifications

**API Routes:**
- `POST /api/integrations/slack/connect` - Connect via webhook URL
- `POST /api/integrations/slack/disconnect` - Disconnect
- `GET /api/integrations/slack/status` - Check connection status

**Connection Flow:**
1. User provides Slack webhook URL
2. System validates URL (must start with `https://hooks.slack.com/`)
3. System tests webhook with test message
4. Connection stored in `IntegrationConnection` table
5. Notifications sent automatically when events occur

**Graceful Degradation:**
- If `SLACK_INTEGRATION_ENABLED=false`, all functions return early (no errors)
- If connection not found, functions return `{ success: false, error: "..." }` (no exceptions)
- If webhook fails, error logged but doesn't break calling code

---

## 2. Notion Integration ✅

### Purpose
Sync brand or deal summaries to Notion pages

### Implementation

**Service:** `apps/api/src/services/integrations/notionService.ts`

**Connection Method:** OAuth access token (simplified - manual token entry)

**Functions:**
- `syncBrandToNotion(userId, brandId)` - Sync brand summary to Notion
- `syncDealToNotion(userId, dealId)` - Sync deal summary to Notion

**API Routes:**
- `POST /api/integrations/notion/connect` - Connect via access token
- `POST /api/integrations/notion/disconnect` - Disconnect
- `POST /api/integrations/notion/sync/brand/:brandId` - Sync brand
- `POST /api/integrations/notion/sync/deal/:dealId` - Sync deal
- `GET /api/integrations/notion/status` - Check connection status

**Connection Flow:**
1. User provides Notion integration token
2. System validates token by calling `client.users.me()`
3. Connection stored in `IntegrationConnection` table
4. User can manually trigger sync via API

**Data Synced:**
- **Brand:** Name, total deals, total value, summary
- **Deal:** Brand name, talent name, value, stage, summary

**Graceful Degradation:**
- If `NOTION_INTEGRATION_ENABLED=false`, returns `{ success: false, error: "..." }`
- If connection not found, returns error (no exceptions)
- If token expired, returns error (no exceptions)
- If database not found, returns clear error message

---

## 3. Google Drive Integration ✅

### Purpose
Link external Google Drive files to CRM records (deals, brands, contracts)

### Implementation

**Service:** `apps/api/src/services/integrations/googleDriveService.ts`

**Connection Method:** OAuth access token + refresh token

**Functions:**
- `linkDriveFileToRecord(userId, fileId, recordType, recordId)` - Link file to CRM record
- `listDriveFiles(userId, query?)` - List user's Drive files

**API Routes:**
- `POST /api/integrations/google-drive/connect` - Connect via tokens
- `POST /api/integrations/google-drive/disconnect` - Disconnect
- `POST /api/integrations/google-drive/link` - Link file to record
- `GET /api/integrations/google-drive/files` - List files
- `GET /api/integrations/google-drive/status` - Check connection status

**Connection Flow:**
1. User provides Google Drive access token + refresh token
2. Connection stored in `IntegrationConnection` table
3. User can link files to CRM records via API

**File Linking:**
- Creates `File` record in database
- Stores Drive file ID, web view link, metadata
- Links to record via `linkedType` and `linkedId`

**Graceful Degradation:**
- If `GOOGLE_DRIVE_INTEGRATION_ENABLED=false`, returns error (no exceptions)
- If connection not found, returns error (no exceptions)
- If token expired (401), automatically disconnects integration and returns clear error
- All errors are logged but don't break calling code

---

## 4. Database Schema ✅

### IntegrationConnection Model

**File:** `apps/api/prisma/schema.prisma`

```prisma
model IntegrationConnection {
  id            String   @id @default(cuid())
  userId        String
  platform      String   // "slack", "notion", "google_drive"
  connected     Boolean   @default(false)
  accessToken   String?
  refreshToken  String?
  expiresAt     DateTime?
  webhookUrl    String?   // For Slack webhooks
  workspaceId   String?   // For Notion workspace
  workspaceName String?   // For Notion workspace name
  metadata      Json?     // Platform-specific data
  lastSyncedAt  DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  User          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform])
  @@index([userId, connected])
  @@index([platform])
}
```

**Relations:**
- `User.IntegrationConnection[]` - One user can have multiple integrations

---

## 5. Feature Flags ✅

### Backend

**File:** `apps/api/src/config/features.ts`

```typescript
SLACK_INTEGRATION_ENABLED: process.env.SLACK_INTEGRATION_ENABLED === "true",
NOTION_INTEGRATION_ENABLED: process.env.NOTION_INTEGRATION_ENABLED === "true",
GOOGLE_DRIVE_INTEGRATION_ENABLED: process.env.GOOGLE_DRIVE_INTEGRATION_ENABLED === "true",
```

### Frontend

**File:** `apps/web/src/config/features.js`

```javascript
SLACK_INTEGRATION_ENABLED: true, // ✅ V1.1: Slack notifications
NOTION_INTEGRATION_ENABLED: true, // ✅ V1.1: Sync brand/deal summaries to Notion
GOOGLE_DRIVE_INTEGRATION_ENABLED: true, // ✅ V1.1: Link external files to CRM records
```

### Environment Variables

```bash
SLACK_INTEGRATION_ENABLED=true
NOTION_INTEGRATION_ENABLED=true
GOOGLE_DRIVE_INTEGRATION_ENABLED=true
```

**Behavior:**
- If flag is `false`, API returns 503 with clear error message
- Frontend checks status and shows "Not connected" if disabled
- All functions gracefully degrade (no exceptions thrown)

---

## 6. UI Integration ✅

### AdminSettingsPage

**File:** `apps/web/src/pages/AdminSettingsPage.jsx`

**Changes:**
- ✅ Integration status checks on page load
- ✅ "Connect" buttons for Slack, Notion, Google Drive
- ✅ "Disconnect" buttons when connected
- ✅ Status display (Connected / Not connected)
- ✅ Connection flow via prompts (simplified - can be enhanced with OAuth flows later)

**Integration Cards:**
- Shows integration name
- Shows connection status
- Shows "Connect" or "Disconnect" button
- Handles loading states
- Shows error messages on failure

---

## 7. API Routes Summary ✅

### Slack
- `POST /api/integrations/slack/connect` - Connect via webhook
- `POST /api/integrations/slack/disconnect` - Disconnect
- `GET /api/integrations/slack/status` - Get status

### Notion
- `POST /api/integrations/notion/connect` - Connect via token
- `POST /api/integrations/notion/disconnect` - Disconnect
- `POST /api/integrations/notion/sync/brand/:brandId` - Sync brand
- `POST /api/integrations/notion/sync/deal/:dealId` - Sync deal
- `GET /api/integrations/notion/status` - Get status

### Google Drive
- `POST /api/integrations/google-drive/connect` - Connect via tokens
- `POST /api/integrations/google-drive/disconnect` - Disconnect
- `POST /api/integrations/google-drive/link` - Link file to record
- `GET /api/integrations/google-drive/files` - List files
- `GET /api/integrations/google-drive/status` - Get status

**All routes:**
- Require authentication (`requireAuth` middleware)
- Check feature flags (return 503 if disabled)
- Return structured JSON responses
- Handle errors gracefully

---

## 8. Graceful Degradation ✅

### Principles

1. **No Exceptions Thrown:**
   - All functions return `{ success: boolean, error?: string }`
   - Errors are logged but don't break calling code

2. **Feature Flag Checks:**
   - All routes check feature flags first
   - Return 503 if disabled (clear error message)

3. **Connection Checks:**
   - Functions check if connection exists
   - Return error if not connected (no exceptions)

4. **Token Expiry Handling:**
   - Google Drive: Automatically disconnects on 401
   - Notion: Returns clear error message
   - Slack: Webhook failures logged but don't break code

5. **Silent Failures:**
   - If integration disabled, functions return early (no errors)
   - UI checks status and shows appropriate state
   - No user-facing errors if integration not configured

---

## 9. Files Created/Modified

### Created
- `apps/api/src/services/integrations/slackService.ts` - Slack notification service
- `apps/api/src/services/integrations/notionService.ts` - Notion sync service
- `apps/api/src/services/integrations/googleDriveService.ts` - Google Drive linking service
- `apps/api/src/routes/integrations.ts` - Integration API routes

### Modified
- `apps/api/prisma/schema.prisma` - Added `IntegrationConnection` model
- `apps/api/src/server.ts` - Mounted integrations router
- `apps/api/src/config/features.ts` - Added feature flags
- `apps/api/src/integrations/slack/slackClient.ts` - Updated to use new service
- `apps/web/src/config/features.js` - Added feature flags
- `apps/web/src/pages/AdminSettingsPage.jsx` - Added integration UI

---

## 10. Usage Examples

### Slack Notification

```typescript
import { notifyDealUpdate } from "../services/integrations/slackService.js";

// When deal status changes
await notifyDealUpdate(userId, {
  id: dealId,
  brandName: "Nike",
  stage: "CLOSED_WON",
  value: 50000,
  currency: "USD"
});
```

### Notion Sync

```typescript
import { syncBrandToNotion } from "../services/integrations/notionService.js";

// Sync brand to Notion
const result = await syncBrandToNotion(userId, brandId);
if (result.success) {
  console.log("Synced to Notion page:", result.pageId);
}
```

### Google Drive Link

```typescript
import { linkDriveFileToRecord } from "../services/integrations/googleDriveService.js";

// Link file to deal
const result = await linkDriveFileToRecord(
  userId,
  "1a2b3c4d5e6f7g8h",
  "deal",
  dealId
);
```

---

## 11. Constraints Enforced ✅

### One-Way Sync Only
- ✅ Slack: Break Agency → Slack (notifications only)
- ✅ Notion: Break Agency → Notion (sync summaries only)
- ✅ Google Drive: Break Agency → Google Drive (link files only)
- ✅ No data pulled from external tools

### Fully Optional
- ✅ All integrations can be disabled via feature flags
- ✅ All functions gracefully degrade if disconnected
- ✅ No errors thrown if integration not configured
- ✅ UI shows appropriate state (connected / not connected)

### Safe Degradation
- ✅ Feature flag checks prevent errors
- ✅ Connection checks prevent errors
- ✅ Token expiry handled gracefully
- ✅ All errors logged but don't break code
- ✅ Clear error messages for users

---

## 12. Future Enhancements

### OAuth Flows
- Full OAuth flows for Notion and Google Drive (currently manual token entry)
- OAuth callback handlers
- Token refresh automation

### Enhanced Notifications
- Configurable notification channels
- Notification preferences per user
- Rich Slack blocks (not just text)

### Enhanced Sync
- Automatic sync on record updates
- Batch sync operations
- Sync history tracking

### Enhanced File Linking
- File picker UI
- Drag-and-drop file linking
- File preview in CRM records

---

## Conclusion

Phase 6 is complete and ready for testing. All three integrations are:
- ✅ Implemented with proper services
- ✅ API routes created and mounted
- ✅ Feature flags configured
- ✅ UI integration complete
- ✅ Graceful degradation enforced
- ✅ One-way sync only
- ✅ Fully optional

The system is ready for productivity integration testing.

